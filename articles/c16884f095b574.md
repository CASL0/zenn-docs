---
title: "SSHç§˜å¯†éµã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºè‡ªå‹•å…¥åŠ›"
emoji: "ğŸ”’"
type: "tech"
topics: ["ssh", "shell", "è‡ªå‹•åŒ–", "gitlab", "cicd"]
published: true
---

## ã¯ã˜ã‚ã«

ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºä»˜ã®ç§˜å¯†éµã‚’ä½¿ã£ã¦ SSH ã™ã‚‹ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã—ãŸã„å ´åˆã«ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è‡ªå‹•å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ä¾‹ãˆã°ã€Gitlab CI ã‚„ GitHub Actions ã‚’ä½¿ã£ã¦ã€æˆæœç‰©ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é…ç½®ã—ãŸã„å ´åˆç­‰ãŒè€ƒãˆã‚‰ã‚Œã‚‹ã€‚

## æº–å‚™

ä»¥ä¸‹ã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚

- SSH ç§˜å¯†éµã‚’ç’°å¢ƒå¤‰æ•°`SSH_PRIVATE_KEY`ã«è¨­å®š
- ä¸Šè¨˜ç§˜å¯†éµã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç’°å¢ƒå¤‰æ•°`SSH_PASSPHRASE`ã«è¨­å®š
- `ssh`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã“ã¨

## æ‰‹é †

```sh
eval $(ssh-agent -s)
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo -e "#!/bin/sh\n\necho ${SSH_PASSPHRASE}" > /etc/ssh/passphrase
chmod 755 /etc/ssh/passphrase
echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | DISPLAY=None SSH_ASKPASS=/etc/ssh/passphrase SSH_ASKPASS_REQUIRE=prefer ssh-add -
ssh-keyscan "${SERVER_HOST}" >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts
# ä»»æ„ã®SSHã‚’å®Ÿè¡Œã§ãã‚‹
ssh ubuntu@"${SERVER_HOST}" "hostname"
scp -r dist ubuntu@"${SERVER_HOST}":~
```

:::message
OpenSSH 8.4 ã‹ã‚‰ç’°å¢ƒå¤‰æ•°`SSH_ASKPASS_REQUIRE`ã§è¿½åŠ ã®åˆ¶å¾¡ãŒå¿…è¦ã«ãªã‚Šã¾ã—ãŸ

<https://www.openssh.com/txt/release-8.4>
:::

:::message
ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå…¥åŠ›ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆä¸Šè¨˜ã®`/etc/ssh/passphrase`ï¼‰ã¯ alpine ã®å ´åˆã€shebang ãŒå¿…è¦ã§ã™[^1][^2]
:::

[^1]: https://github.com/alpinelinux/docker-alpine/issues/404
[^2]: [ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå…¥åŠ›ç”¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ exec ã—ã¦ã„ã‚‹ç®‡æ‰€](https://github.com/openssh/openssh-portable/blob/5f761cdb2331a12318bde24db5ca84ee144a51d1/readpass.c#L80-L81)
