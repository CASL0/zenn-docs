---
title: "SSH秘密鍵のパスフレーズ自動入力"
emoji: "🔒"
type: "tech"
topics: ["ssh", "shell", "自動化", "gitlab", "cicd"]
published: true
---

## はじめに

パスフレーズ付の秘密鍵を使って SSH する作業を自動化したい場合に、パスフレーズを自動入力する必要がある。
例えば、Gitlab CI や GitHub Actions を使って、成果物をサーバーに配置したい場合等が考えられる。

## 準備

以下を準備してください。

- SSH 秘密鍵を環境変数`SSH_PRIVATE_KEY`に設定
- 上記秘密鍵のパスフレーズを環境変数`SSH_PASSPHRASE`に設定
- `ssh`をインストールしていること

## 手順

```sh
eval $(ssh-agent -s)
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo -e "#!/bin/sh\n\necho ${SSH_PASSPHRASE}" > /etc/ssh/passphrase
chmod 755 /etc/ssh/passphrase
echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | DISPLAY=None SSH_ASKPASS=/etc/ssh/passphrase SSH_ASKPASS_REQUIRE=prefer ssh-add -
ssh-keyscan "${SERVER_HOST}" >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts
# 任意のSSHを実行できる
ssh ubuntu@"${SERVER_HOST}" "hostname"
scp -r dist ubuntu@"${SERVER_HOST}":~
```

:::message
OpenSSH 8.4 から環境変数`SSH_ASKPASS_REQUIRE`で追加の制御が必要になりました

<https://www.openssh.com/txt/release-8.4>
:::

:::message
パスフレーズ入力用のプログラム（上記の`/etc/ssh/passphrase`）は alpine の場合、shebang が必要です[^1][^2]
:::

[^1]: https://github.com/alpinelinux/docker-alpine/issues/404
[^2]: [パスフレーズ入力用のプログラムを exec している箇所](https://github.com/openssh/openssh-portable/blob/5f761cdb2331a12318bde24db5ca84ee144a51d1/readpass.c#L80-L81)
