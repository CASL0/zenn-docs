---
title: "kubesprayã¨ãƒ©ã‚ºãƒ‘ã‚¤ã§ãŠã†ã¡Kubernetes"
emoji: "ğŸŒŸ"
type: "tech"
topics: ["kubernetes", "raspberrypi", "ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹", "ansible", "kubespray"]
published: true
---

## ã¯ã˜ã‚ã«

[kubespray](https://github.com/kubernetes-sigs/kubespray)ã¨ãƒ©ã‚ºãƒ‘ã‚¤ã‚’ä½¿ã£ã¦ã€ãŠã†ã¡ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
æ§‹æˆã¯ Control Plane ãŒ 1 å°ã€Worker Node ãŒ 2 å°ã®åˆè¨ˆ 3 å°ã§æ§‹ç¯‰ã—ã¾ã™ã€‚

![å†™çœŸ](https://raw.githubusercontent.com/CASL0/ansible/images/mycluster.jpeg =500x)

ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/CASL0/ansible

## ææ–™

é…ç·šãŒç…©é›‘ã«ãªã‚‹ã®ãŒå«Œã ã£ãŸã®ã§ã€PoE ã§çµ¦é›»ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

| åå‰                                                                                   | å˜ä¾¡      | å€‹æ•° | å‚™è€ƒ                      |
| -------------------------------------------------------------------------------------- | --------- | ---- | ------------------------- |
| [Raspberry Pi 4 Model B 8GB](https://raspberry-pi.ksyic.com/?pdp.id=552)               | 16,800 å†† | 3    |                           |
| [ã‚¢ã‚¯ãƒªãƒ«ã‚±ãƒ¼ã‚¹ä»˜ã PoE HAT](https://www.amazon.co.jp/dp/B097NCD6FW)                   | 3,599 å††  | 3    |                           |
| [TP-Link TL-SG105PE](https://www.amazon.co.jp/dp/B08GDC61NS)                           | 6,667 å††  | 1    | PoE çµ¦é›»ã«å¯¾å¿œ            |
| [microSD ã‚«ãƒ¼ãƒ‰ 64GB](https://www.amazon.co.jp/dp/B07DVJ86SS)                          | 980 å††    | 3    |                           |
| [HDMI (ãƒ¡ã‚¹) - micro HDMI (ã‚ªã‚¹) å¤‰æ›ã‚¢ãƒ€ãƒ—ã‚¿](https://www.amazon.co.jp/dp/B01017VGR2) | 970 å††    | 1    | OS ã®åˆæœŸåŒ–ãƒ»ssh ã®è¨­å®šç”¨ |

## OS ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Raspberry Pi Imager ã‚’ä½¿ã£ã¦ OS ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ä»¥ä¸‹ãƒªãƒ³ã‚¯ã® Raspberry Pi Imager ã®å…¬å¼ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Raspberry Pi Imager ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
https://www.raspberrypi.com/software/

ã“ã®è¨˜äº‹ã§ã¯ Ubuntu24.04 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
[Other general-purpose OS]>[Ubuntu]>[Ubuntu Server 24.04.1 LTS (64-bit)]ã¨é·ç§»ã—ã¦ã€OS ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

![](/images/raspberry-pi-imager.png =600x)

## æ§‹ç¯‰

kubespray ã¯ Ansible ã® collection ã§ã™ã€‚å¤‰æ•°ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å†…å®¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€helm ã‚„ ingress ç­‰ã® addon ã‚‚ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

### æ§‹æˆ

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Kubernetesï¼šv1.30.4
- CNIï¼šflannel
- addon:
  - helm
  - metrics_server
  - cert_manager
  - metallb
  - ingress_nginx

Playbook ã«ã™ã‚‹ã¨ã“ã†ãªã‚Šã¾ã™ã€‚

```yaml
---
- name: Install Kubernetes
  ansible.builtin.import_playbook: kubernetes_sigs.kubespray.cluster
  vars:
    kube_version: v1.30.4
    kube_network_plugin: flannel
    kubeconfig_localhost: true
    kubectl_localhost: true
    helm_enabled: true
    metrics_server_enabled: true
    cert_manager_enabled: true
    kube_proxy_strict_arp: true
    metallb_enabled: true
    metallb_speaker_enabled: true
    metallb_namespace: metallb-system
    metallb_config:
      address_pools:
        primary:
          ip_range:
            - 192.168.0.100-192.168.0.200 # ã”è‡ªèº«ã®ç’°å¢ƒã§èª­ã¿æ›¿ãˆã¦ãã ã•ã„
          auto_assign: true
      layer2:
        - primary
    ingress_nginx_enabled: true
    ingress_nginx_namespace: ingress-nginx
```

:::message
metallb ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ—ãƒ¼ãƒ«ã¯ã€ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦èª­ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚
ç­†è€…ã®å ´åˆã¯ 192.168.0.0/24 ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ãªã£ã¦ãŠã‚Šã€ãã®ä¸­ã§ 100-200 ã¾ã§ã‚’ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ—ãƒ¼ãƒ«ã¨ã—ã¾ã—ãŸã€‚
:::

### å®Ÿè¡Œ

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ clone ã—ã¦ãã ã•ã„ã€‚

```sh
git clone https://github.com/CASL0/ansible.git
```

[inventories/hosts](https://github.com/CASL0/ansible/blob/main/inventories/hosts)ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```sh
python -m venv .env
source .env/bin/activate
pip install -r requirements.txt
ansible-galaxy install -r requirements.yml
ansible-playbook playbooks/mycluster.yml -b
```

æˆåŠŸã™ã‚‹ã¨ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸãƒã‚·ãƒ³ï¼ˆControl nodeï¼‰ã« kubeconfigï¼ˆadmin.confï¼‰ ã¨ kubectl ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ Kubernetes ã® API ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sh
cd inventories/artifacts
./kubectl.sh get nodes
```

å„ Node ã® STATUS ãŒ Ready ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```text
NAME          STATUS   ROLES           AGE   VERSION
192.168.0.5   Ready    control-plane   2h   v1.30.4
192.168.0.6   Ready    <none>          2h   v1.30.4
192.168.0.7   Ready    <none>          2h   v1.30.4
```
